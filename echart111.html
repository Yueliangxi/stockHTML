<!DOCTYPE html>
<!-- 为英文，下面为中文 -->
<!-- <html lang="en"> -->
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- 引入 Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      /* 浏览器全屏状态下背景颜色设置：main是div里面的选择器 */
      #main:-webkit-full-screen {
        background-color: #056197 !important;
      }
      #main:-moz-full-screen {
        background-color: #056197 !important;
      }
      #main:-ms-fullscreen {
        background-color: #056197 !important;
      }
      #main:fullscreen{
        background-color: #056197 !important;
      }
      </style>
</head>

<body>

  <!-- 輸入框和確認按鈕 -->
  <div class="container mt-3">
    <div class="row">
        <!-- Input field -->
        <div class="col-md-10">
            <input type="text" class="form-control" id="stockCodeInput" placeholder="输入股票代码">
        </div>
        
        <!-- Confirm button -->
        <div class="col-md-2">
            <button class="btn btn-primary w-100" id="confirmButton">确认</button>
        </div>
    </div>
  </div>

  <br>

  <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
  <!-- <div id="main" style="width: 1200px; height: 600px;"></div> -->
  <div class="container-fluid">
    <div id="main" style="width: 100%; height: 600px;"></div>
  </div>

</body>
<script src=js/echarts.js type="text/javascript" ></script>
<script>

  $(document).ready(function() {
      // 点击事件监听器
      $("#confirmButton").click(function() {
          // 获取输入框的值
          var stockCode = $("#stockCodeInput").val();

          // 请求的数据
          let data = {
              "stockCode": stockCode
          };

          // 使用 jQuery 的 Ajax 发送 POST 请求
          $.ajax({
              url: 'https://4romz0l969.execute-api.ap-southeast-2.amazonaws.com/search/stock',
              type: 'POST',
              data: JSON.stringify(data), 
              contentType: 'application/json',
              success: function(response) {
                  console.log(response);
                  // Update the ECharts with the data from the response
                  updateChart(response);
                  alert('Data sent successfully.');
              },
              error: function(error) {
                  console.log(error);
                  alert('Error sending data.');
              }
          });
      });
  });

  function updateChart(responseData) {   // <- 添加这个函数
      // Assuming responseData has the structure: {dates: [], values: []}
      var data0 = splitData(responseData.dates.map((date, index) => {
          return [date].concat(responseData.values[index]);
      }));
      option.xAxis.data = data0.categoryData;
      option.series[0].data = data0.values;
      option.series[5].data = data0.rehabData;
      // And so on for other series like MA5, MA10, etc...
      myChart.setOption(option);
  }



/*基于准备好的dom，初始化echarts实例*/
 var myChart = echarts.init(document.getElementById('main'));
 
 // 数据意义：开盘(open)，收盘(close)，最低(lowest)，最高(highest)

 //切割数组，把数组中的日期和数据分离，返回数组中的日期和数据
 function splitData(rawData) {
  var categoryData = [];
  var values = [];
  var rehabData = [];
   
  for (var i = 0; i < rawData.length; i++) {
  //splice 返回每组数组中被删除的第一项，即返回数组中被删除的日期 
  //alert(rawData[i].splice(0, 1)[0]);
  //categoryData 日期 把返回的日期放到categoryData[]数组中
  categoryData.push(rawData[i].splice(0, 1)[0]);
  //alert(categoryData);
  rehabData.push(rawData[i].splice(-1, 1)[0]);
  //数据数组，即数组中除日期外的数据
  // alert(rawData[i]);
  values.push(rawData[i])
  }
  return {
  categoryData: categoryData, //数组中的日期 x轴对应的日期                
  values: values,  //数组中的数据 y轴对应的数据
  rehabData: rehabData
  };
 }


 //计算MA平均线，N日移动平均线=N日收盘价之和/N dayCount要计算的天数(5,10,20,30)
 function calculateMA(dayCount) {
  var result = [];
  for (var i = 0, len = data0.values.length; i < len; i++) {
  if (i < dayCount) {
   result.push('-');
   //alert(result);
   continue; //结束单次循环，即不输出本次结果
  }
  var sum = 0;
  for (var j = 0; j < dayCount; j++) {
   //收盘价总和
   sum += data0.values[i - j][1];
   //alert(sum);
  }
  result.push(sum / dayCount);
  // alert(result);
  }
  return result;
 }
 option = {
  title: { //标题
  text: '上证指数',
  left: 0
  },
  tooltip: { //提示框
  trigger: 'axis', //触发类型：坐标轴触发
  axisPointer: { //坐标轴指示器配置项
   type: 'cross' //指示器类型，十字准星
  }
  },
  legend: { //图例控件，点击图例控制哪些系列不现实
  data: ['日K', 'MA5', 'MA10', 'MA20', 'MA30', 'REHABILITATION']
  },
  grid: { //直角坐标系
  show:true,
  left: '10%', //grid组件离容器左侧的距离
  right: '10%',
  bottom: '15%',
  //backgroundColor:'#ccc'
  },
  xAxis: {
  type: 'category', //坐标轴类型，类目轴
  data: data0.categoryData,
  //scale: true, //只在数字轴中有效
  boundaryGap : false, //刻度作为分割线，标签和数据点会在两个刻度上
  axisLine: {onZero: false},
  splitLine: {show: false}, //是否显示坐标轴轴线
  //splitNumber: 20, //坐标轴的分割段数，预估值，在类目轴中无效
  min: 'dataMin', //特殊值，数轴上的最小值作为最小刻度
  max: 'dataMax' //特殊值，数轴上的最大值作为最大刻度
  },
  yAxis: {
  scale: true, //坐标刻度不强制包含零刻度
  position:'right',
  splitArea: {
   show: true //显示分割区域
  }
  },
  dataZoom: [ //用于区域缩放
  {
   filterMode:'filter', //当前数据窗口外的数据被过滤掉来达到数据窗口缩放的效果 默认值filter
   type: 'inside', //内置型数据区域缩放组件
   start: 50, //数据窗口范围的起始百分比
   end: 100 //数据窗口范围的结束百分比
  },
  {
   show: true,
   type: 'slider', //滑动条型数据区域缩放组件
   y: '90%',
   start: 50,
   end: 100
  }
  ],
  series: [ //图表类型
  {
   name: '日K',
   type: 'candlestick', //K线图
   data: data0.values, //y轴对应的数据图标标注/
   itemStyle:{
    normal:{
     color0:'#ef232a',
     color:'#14b143',
     borderColor0:'#ef232a',
     borderColor:'#14b143'
    }
   },
   markPoint: { //图表标注
    symbol: 'none',
    symbolSize: 50,
    label: { //标注的文本
    normal: { //默认不显示标注
    show:true,
    //position:['20%','30%'],
    formatter: function (param) { //标签内容控制器
     return param != null ? Math.round(param.value) : '';
    }
    }
   },
   data: [ //标注的数据数组
    // {
    // name: 'XX标点',
    // coord: ['2013/5/31', 2300], //指定数据的坐标位置
    // value: 2300,
    // itemStyle: { //图形样式
    //  normal: {color: 'rgb(41,60,85)'}
    // }
    // },
    {
    name: 'highest value',
    type: 'max', //最大值
    valueDim: 'highest' //在highest维度上的最大值 最高价
    },
    {
    name: 'lowest value',
    type: 'min',
    valueDim: 'lowest' //最低价
    }
    //,
    // {
    // name: 'average value on close',
    // type: 'average',
    // valueDim: 'close' //收盘价
    // }
   ],
   tooltip: { //提示框
    formatter: function (param) {
    return param.name + '<br>' + (param.data.coord || '');
    }
   }
   }
 
  },
 
  { //MA5 5天内的收盘价之和/5
   name: 'MA5',
   type: 'line',
   data: calculateMA(5),
   smooth: true,
   lineStyle: {
   normal: {opacity: 0.5}
   }
  },
  {
   name: 'MA10',
   type: 'line',
   data: calculateMA(10),
   smooth: true,
   lineStyle: { //标线的样式
   normal: {opacity: 0.5}
   }
  },
  {
   name: 'MA20',
   type: 'line',
   data: calculateMA(20),
   smooth: true,
   lineStyle: {
   normal: {opacity: 0.5}
   }
  },
  {
   name: 'MA30',
   type: 'line',
   data: calculateMA(30),
   smooth: true,
   lineStyle: {
   normal: {opacity: 0.5}
   }
  },
  {
    name: 'REHAB',
    type: 'line',
    data: data0.rehabData,
    smooth: true,
    lineStyle: {
    normal: {opacity: 0.5}
    }

  },
  ]
 };
 myChart.setOption(option);
</script>

</html>
